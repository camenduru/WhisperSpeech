<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>WhisperSpeech - Precompute Whisper transcriptions for VQ bottleneck distilation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="WhisperSpeech - Precompute Whisper transcriptions for VQ bottleneck distilation">
<meta property="og:description" content="">
<meta property="og:image" content="https://collabora.github.io/WhisperSpeech/2A. Whisper quantization dataset preparation_files/figure-html/cell-8-output-1.png">
<meta property="og:site-name" content="WhisperSpeech">
<meta property="og:image:height" content="435">
<meta property="og:image:width" content="569">
<meta name="twitter:title" content="WhisperSpeech - Precompute Whisper transcriptions for VQ bottleneck distilation">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://collabora.github.io/WhisperSpeech/2A. Whisper quantization dataset preparation_files/figure-html/cell-8-output-1.png">
<meta name="twitter:image-height" content="435">
<meta name="twitter:image-width" content="569">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    <img src="./logo.svg" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">WhisperSpeech</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/collabora/WhisperSpeech" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Precompute Whisper transcriptions for VQ bottleneck distilation</li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">WhisperSpeech</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dataset preparation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">I can has speech? What data WhisperSpeech needs?</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#merge-vad-segments-into-longer-chunks" id="toc-merge-vad-segments-into-longer-chunks" class="nav-link active" data-scroll-target="#merge-vad-segments-into-longer-chunks">Merge VAD segments into longer chunks</a></li>
  <li><a href="#merge-the-flac-and-vad-datasets" id="toc-merge-the-flac-and-vad-datasets" class="nav-link" data-scroll-target="#merge-the-flac-and-vad-datasets">Merge the FLAC and VAD datasets</a></li>
  <li><a href="#split-the-audio-into-chunks" id="toc-split-the-audio-into-chunks" class="nav-link" data-scroll-target="#split-the-audio-into-chunks">Split the audio into chunks</a></li>
  <li><a href="#transcribe" id="toc-transcribe" class="nav-link" data-scroll-target="#transcribe">Transcribe</a></li>
  <li><a href="#transcribe-in-batches" id="toc-transcribe-in-batches" class="nav-link" data-scroll-target="#transcribe-in-batches">Transcribe in batches</a></li>
  <li><a href="#verify-the-transcripts-and-the-chunks-work-together" id="toc-verify-the-transcripts-and-the-chunks-work-together" class="nav-link" data-scroll-target="#verify-the-transcripts-and-the-chunks-work-together">Verify the transcripts and the chunks work together</a></li>
  <li><a href="#batch-processing" id="toc-batch-processing" class="nav-link" data-scroll-target="#batch-processing">Batch processing</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/collabora/WhisperSpeech/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Precompute Whisper transcriptions for VQ bottleneck distilation</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>Doing transcription means sampling from the Whisper auto-regresive decoder. This is too slow to do for each training batch. Fortunately the trainscriptions are small text snippets so we can precompute them once for the whole dataset.</p>
<p>We use segments from Voice Activity Detection to reduce any boundary issues, the we use webdataset to yields multiple chunks from a FLAC file we only load once. The VAD segments are merged into longer chunks to make Whisper processing more efficent (it always processes 30s at a time)</p>
<p><strong>Usage:</strong></p>
<pre><code>python -m whisperspeech.wh_transcribe librilight-large-wo6454-flac-000002.tar</code></pre>
<p>You can pass in either a URL or a local file name. Either way it will expect a <code>vad</code> file in the local directory. The result will go into a file in the current directory named after the source file but replacing <code>flac</code> with <code>txt</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The autoreload extension is already loaded. To reload it, use:
  %reload_ext autoreload</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pylab <span class="im">as</span> plt</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> IPython</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>flac_url <span class="op">=</span> <span class="st">'https://huggingface.co/datasets/collabora/librilight-webdataset/resolve/main/librilight-small-flac-000000.tar'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>flac_url <span class="op">=</span> <span class="st">'./librilight-small-flac-000000.tar'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="merge-vad-segments-into-longer-chunks" class="level2">
<h2 class="anchored" data-anchor-id="merge-vad-segments-into-longer-chunks">Merge VAD segments into longer chunks</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load some VAD ouputs</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>ds <span class="op">=</span> wds.WebDataset(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    vad.flac_to_vad_name(flac_url)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>).decode().to_tuple(<span class="st">'vad.npy'</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>chunks <span class="op">=</span> [x[<span class="dv">0</span>] <span class="cf">for</span> x <span class="kw">in</span> progress_bar(ds, total<span class="op">=</span><span class="st">'noinfer'</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="335" class="" max="335" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [335/335 00:00&lt;00:00]
    </div>
    
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># quick test</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(chunks[<span class="dv">0</span>]), <span class="bu">len</span>(chunk_merger(chunks[<span class="dv">0</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(46, 28)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>plt.hist([te<span class="op">-</span>ts <span class="cf">for</span> x <span class="kw">in</span> chunks <span class="cf">for</span> ts,te <span class="kw">in</span> x])</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Segment length distribution straight out of the VAD algorithm'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2A. Whisper quantization dataset preparation_files/figure-html/cell-8-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>plt.hist([te<span class="op">-</span>ts <span class="cf">for</span> x <span class="kw">in</span> chunks <span class="cf">for</span> ts,te <span class="kw">in</span> chunk_merger(x)])<span class="op">;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Chunk length distribution after greedy merging'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2A. Whisper quantization dataset preparation_files/figure-html/cell-9-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>(np.array([te<span class="op">-</span>ts <span class="cf">for</span> x <span class="kw">in</span> chunks <span class="cf">for</span> ts,te <span class="kw">in</span> chunk_merger(x)]) <span class="op">&lt;</span> <span class="dv">10</span>).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>0.03671825647504738</code></pre>
</div>
</div>
<p>In the above distribution only 3,7% of the samples have &lt; 10 seconds. We noticed that this limits the ability of the T2S model to generate short sequences reliably.</p>
<p>It does not seem to matter for quantizing Whisper so we can keep this distribution (it uses less compute for training).</p>
<p>For T2S we can add some more shorter chunks at random:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>plt.hist([te<span class="op">-</span>ts <span class="cf">for</span> x <span class="kw">in</span> chunks <span class="cf">for</span> ts,te <span class="kw">in</span> chunk_merger(x, random_cutter)])</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Chunk length distribution after randomized merging'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2A. Whisper quantization dataset preparation_files/figure-html/cell-11-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="merge-the-flac-and-vad-datasets" class="level2">
<h2 class="anchored" data-anchor-id="merge-the-flac-and-vad-datasets">Merge the FLAC and VAD datasets</h2>
<p>First we want to merge the VAD dataset with the FLAC audio data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>ds <span class="op">=</span> wds_compose(vad.load_dataset(flac_url),</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    merge_in(wds.WebDataset(vad.flac_to_vad_name(flac_url)).decode())</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> s <span class="kw">in</span> ds: <span class="cf">break</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>s <span class="co"># notice the 'vad.npy' values that was missing from the FLAC dataset</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'__key__': 'small/100/sea_fairies_0812_librivox_64kb_mp3/01_baum_sea_fairies_64kb',
 '__url__': 'librilight-small-vad-000000.tar.gz',
 'flac': (tensor([[0., 0., 0.,  ..., 0., 0., 0.]]), 16000),
 'json': {'speaker': '100',
  'book_meta': {'id': '2315',
   'title': 'Sea Fairies',
   'description': "&lt;p&gt;In 1910, Baum hoped to end the Oz series and follow with a new series about a little girl named Trot and her sailor companion, Cap'n Bill. The Sea Fairies (1911) was the first book in the projected series and took Trot and Cap'n Bill under the sea where they had adventures with mermaids and other fantastic creatures. It was followed by Sky Island (1912) and then Baum returned to the Oz titles. He brought Trot and Cap'n Bill to Oz in the Scarecrow of Oz (1915). (Summary by Judy Bieber)&lt;/p&gt;",
   'url_text_source': 'http://www.gutenberg.org/etext/4358',
   'language': 'English',
   'copyright_year': '1911',
   'num_sections': '22',
   'url_rss': 'https://librivox.org/rss/2315',
   'url_zip_file': 'http://www.archive.org/download/sea_fairies_0812_librivox/sea_fairies_0812_librivox_64kb_mp3.zip',
   'url_project': 'http://en.wikipedia.org/wiki/The_Sea_Fairies',
   'url_librivox': 'https://librivox.org/the-sea-fairies-by-l-frank-baum/',
   'url_other': None,
   'totaltimesecs': 15311,
   'authors': [{'id': '406',
     'first_name': 'L. Frank',
     'last_name': 'Baum',
     'dob': '1856',
     'dod': '1919'}],
   'genre': ['Action &amp; Adventure'],
   'Dramatic Readings': False,
   'meta_genre': 'Literature'},
  'snr': 11.4471,
  'voice_activity': [[1.52, 11.2],
   [11.84, 14.08],
   [15.12, 35.76],
   [36.32, 55.6],
   [56.24, 70.48],
   [71.28, 79.52],
   [80.08, 89.76],
   [90.24, 97.52],
   [98.0, 101.28],
   [102.8, 124.88],
   [125.36, 133.12],
   [133.68, 154.16],
   [154.64, 177.2],
   [178.0, 196.96],
   [197.68, 211.44],
   [212.32, 216.32],
   [216.96, 243.52],
   [244.0, 250.72],
   [251.52, 268.32],
   [268.96, 308.56],
   [309.04, 315.28],
   [316.0, 317.36],
   [317.92, 325.44],
   [326.24, 343.6],
   [344.08, 350.32],
   [350.88, 356.64],
   [357.2, 363.2],
   [363.76, 365.2],
   [365.2, 373.2],
   [373.84, 392.0],
   [392.56, 401.04],
   [401.6, 456.96],
   [457.68, 501.92],
   [502.4, 531.04],
   [531.6, 554.48],
   [554.96, 568.32],
   [568.96, 585.84],
   [587.04, 588.48],
   [597.12, 597.92]]},
 'vad.npy': array([[  1.764,   6.49 ],
        [  6.773,  11.18 ],
        [ 11.98 ,  14.03 ],
        [ 15.31 ,  36.3  ],
        [ 36.3  ,  56.06 ],
        [ 56.4  ,  70.6  ],
        [ 71.4  , 101.2  ],
        [102.75 , 103.56 ],
        [103.7  , 121.75 ],
        [122.06 , 125.   ],
        [125.44 , 133.4  ],
        [133.8  , 154.6  ],
        [154.6  , 177.6  ],
        [178.1  , 197.2  ],
        [197.9  , 212.1  ],
        [212.5  , 222.5  ],
        [222.8  , 243.6  ],
        [244.2  , 246.5  ],
        [246.8  , 251.1  ],
        [251.5  , 256.2  ],
        [256.5  , 257.8  ],
        [258.2  , 259.8  ],
        [259.8  , 268.5  ],
        [269.2  , 289.8  ],
        [289.8  , 315.8  ],
        [316.   , 317.2  ],
        [318.   , 319.   ],
        [319.8  , 344.   ],
        [344.2  , 350.2  ],
        [351.   , 352.5  ],
        [353.   , 356.8  ],
        [357.5  , 373.5  ],
        [374.   , 388.   ],
        [388.2  , 397.2  ],
        [397.5  , 401.5  ],
        [401.8  , 423.5  ],
        [423.5  , 448.   ],
        [448.   , 457.2  ],
        [457.8  , 460.8  ],
        [461.   , 477.8  ],
        [478.5  , 502.2  ],
        [502.2  , 527.5  ],
        [527.5  , 550.5  ],
        [550.5  , 576.5  ],
        [577.   , 586.   ],
        [587.5  , 588.5  ]], dtype=float16)}</code></pre>
</div>
</div>
</section>
<section id="split-the-audio-into-chunks" class="level2">
<h2 class="anchored" data-anchor-id="split-the-audio-into-chunks">Split the audio into chunks</h2>
<p>After we merge the datasets and chunk the segments we can split each audio file into individual samples and pad them to 30s.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>split_ds <span class="op">=</span> wds_compose(ds,</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>   wds.map_dict(<span class="op">**</span>{<span class="st">"vad.npy"</span>:chunk_merger}),</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>   split_to_chunks,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> s <span class="kw">in</span> split_ds: <span class="cf">break</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'__key__': 'small/100/sea_fairies_0812_librivox_64kb_mp3/01_baum_sea_fairies_64kb_000',
 '__url__': 'librilight-small-vad-000000.tar.gz',
 'i': 0,
 'imax': 27,
 'tstart': 1.764,
 'tend': 14.03,
 'total_seconds': 597.9425,
 'samples': tensor([0., 0., 0.,  ..., 0., 0., 0.])}</code></pre>
</div>
</div>
</section>
<section id="transcribe" class="level2">
<h2 class="anchored" data-anchor-id="transcribe">Transcribe</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>whmodel <span class="op">=</span> whisper.load_model(<span class="st">'base.en'</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>decoding_options <span class="op">=</span> whisper.DecodingOptions(language<span class="op">=</span><span class="st">'en'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>output <span class="op">=</span> flac_url.rsplit(<span class="st">"/"</span>, <span class="dv">1</span>)[<span class="dv">1</span>].replace(<span class="st">'flac'</span>, <span class="st">'txt'</span>) <span class="op">+</span> <span class="st">".gz"</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> wds.TarWriter(output) <span class="im">as</span> sink:</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> s <span class="kw">in</span> progress_bar(split_ds, total<span class="op">=</span><span class="dv">256</span>):</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>        mel <span class="op">=</span> whisper.log_mel_spectrogram(s[<span class="st">'samples'</span>].unsqueeze(<span class="dv">0</span>).cuda())</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>        embs <span class="op">=</span> whmodel.encoder(mel)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>        decs <span class="op">=</span> whmodel.decode(embs, decoding_options)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>        sink.write({</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">"__key__"</span>: s[<span class="st">'__key__'</span>],</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">"txt"</span>: decs[<span class="dv">0</span>].text,</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="256" class="" max="256" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [256/256 00:59&lt;00:00]
    </div>
    
</div>
</div>
</section>
<section id="transcribe-in-batches" class="level2">
<h2 class="anchored" data-anchor-id="transcribe-in-batches">Transcribe in batches</h2>
<p>We have one more thing to add – batch processing makes the transcription quite a bit faster (bs=16 brings a 4.5x speedup).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>batched_ds <span class="op">=</span> wds_compose(split_ds,</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    wds.to_tuple(<span class="st">'__key__'</span>, <span class="st">'samples'</span>),</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    wds.batched(<span class="dv">16</span>),</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>output <span class="op">=</span> flac_url.rsplit(<span class="st">"/"</span>, <span class="dv">1</span>)[<span class="dv">1</span>].replace(<span class="st">'flac'</span>, <span class="st">'txt'</span>) <span class="op">+</span> <span class="st">".gz"</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> wds.TarWriter(output) <span class="im">as</span> sink:</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> keys, samples <span class="kw">in</span> progress_bar(batched_ds, total<span class="op">=</span><span class="dv">256</span><span class="op">//</span><span class="dv">16</span>):</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>        mel <span class="op">=</span> whisper.log_mel_spectrogram(samples).cuda()</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>        embs <span class="op">=</span> whmodel.encoder(mel)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>        decs <span class="op">=</span> whmodel.decode(embs, decoding_options)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key, dec <span class="kw">in</span> <span class="bu">zip</span>(keys, decs):</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>            sink.write({</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>                <span class="st">"__key__"</span>: key,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>                <span class="st">"txt"</span>: dec.text,</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>            })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="16" class="" max="16" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [16/16 00:11&lt;00:00]
    </div>
    
</div>
</div>
</section>
<section id="verify-the-transcripts-and-the-chunks-work-together" class="level2">
<h2 class="anchored" data-anchor-id="verify-the-transcripts-and-the-chunks-work-together">Verify the transcripts and the chunks work together</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>txt_ds <span class="op">=</span> wds_compose(split_ds,</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    merge_in(wds.WebDataset(flac_url.rsplit(<span class="st">"/"</span>, <span class="dv">1</span>)[<span class="dv">1</span>].replace(<span class="st">'flac'</span>, <span class="st">'txt'</span>) <span class="op">+</span> <span class="st">".gz"</span>).decode())</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> txt_ds: <span class="cf">break</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'__key__': 'small/100/sea_fairies_0812_librivox_64kb_mp3/01_baum_sea_fairies_64kb_000',
 '__url__': 'librilight-small-txt-000000.tar.gz',
 'i': 0,
 'imax': 27,
 'tstart': 1.764,
 'tend': 14.03,
 'total_seconds': 597.9425,
 'samples': tensor([0., 0., 0.,  ..., 0., 0., 0.]),
 'txt': 'This is a LibraVox recording. Holy bivox recordings are in the public domain. For more information or to volunteer, please visit libravox.org.'}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> progress_bar(txt_ds, total<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    IPython.display.display(IPython.display.Markdown(<span class="ss">f"#### </span><span class="sc">{</span>x[<span class="st">'__key__'</span>]<span class="sc">}</span><span class="ss"> chunk </span><span class="sc">{</span>x[<span class="st">'i'</span>]<span class="sc">}</span><span class="ss"> of </span><span class="sc">{</span>x[<span class="st">'imax'</span>]<span class="sc">}</span><span class="ss">"</span>))</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    fname <span class="op">=</span> <span class="ss">f"test-</span><span class="sc">{</span>x[<span class="st">'i'</span>]<span class="sc">}</span><span class="ss">.ogg"</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    torchaudio.save(fname, x[<span class="st">'samples'</span>][<span class="va">None</span>,:<span class="bu">int</span>((x[<span class="st">'tend'</span>]<span class="op">-</span>x[<span class="st">'tstart'</span>])<span class="op">*</span><span class="dv">16000</span>)], <span class="dv">16000</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    IPython.display.display(IPython.display.Audio(url<span class="op">=</span>fname, rate<span class="op">=</span><span class="dv">16000</span>))</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    IPython.display.display(IPython.display.Markdown(x[<span class="st">'txt'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="10" class="" max="10" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [10/10 00:00&lt;00:00]
    </div>
    
</div>
<section id="small100sea_fairies_0812_librivox_64kb_mp301_baum_sea_fairies_64kb_000-chunk-0-of-27" class="level4 cell-output cell-output-display">
<h4 class="anchored" data-anchor-id="small100sea_fairies_0812_librivox_64kb_mp301_baum_sea_fairies_64kb_000-chunk-0-of-27">small/100/sea_fairies_0812_librivox_64kb_mp3/01_baum_sea_fairies_64kb_000 chunk 0 of 27</h4>
</section>
<div class="cell-output cell-output-display">

                <audio controls="controls">
                    <source src="test-0.ogg" type="audio/ogg">
                    Your browser does not support the audio element.
                </audio>
              
</div>
<div class="cell-output cell-output-display">
<p>This is a LibraVox recording. Holy bivox recordings are in the public domain. For more information or to volunteer, please visit libravox.org.</p>
</div>
<section id="small100sea_fairies_0812_librivox_64kb_mp301_baum_sea_fairies_64kb_001-chunk-1-of-27" class="level4 cell-output cell-output-display">
<h4 class="anchored" data-anchor-id="small100sea_fairies_0812_librivox_64kb_mp301_baum_sea_fairies_64kb_001-chunk-1-of-27">small/100/sea_fairies_0812_librivox_64kb_mp3/01_baum_sea_fairies_64kb_001 chunk 1 of 27</h4>
</section>
<div class="cell-output cell-output-display">

                <audio controls="controls">
                    <source src="test-1.ogg" type="audio/ogg">
                    Your browser does not support the audio element.
                </audio>
              
</div>
<div class="cell-output cell-output-display">
<p>The oceans are being in broad. I believe two-thirds of the Earth’s surface is covered with water. What people inhabit this water has always been a subject of curiosity to the inhabitants of the land. Strange creatures come from the seas at times, and perhaps in the ocean depths are many more strange than mortal eye has ever gazed upon.</p>
</div>
<section id="small100sea_fairies_0812_librivox_64kb_mp301_baum_sea_fairies_64kb_002-chunk-2-of-27" class="level4 cell-output cell-output-display">
<h4 class="anchored" data-anchor-id="small100sea_fairies_0812_librivox_64kb_mp301_baum_sea_fairies_64kb_002-chunk-2-of-27">small/100/sea_fairies_0812_librivox_64kb_mp3/01_baum_sea_fairies_64kb_002 chunk 2 of 27</h4>
</section>
<div class="cell-output cell-output-display">

                <audio controls="controls">
                    <source src="test-2.ogg" type="audio/ogg">
                    Your browser does not support the audio element.
                </audio>
              
</div>
<div class="cell-output cell-output-display">
<p>This story is fanciful. In it the sea people talk and act much as we do, and the mermaids especially are not unlike the fairies with whom we have learned to be familiar. Yet they are real sea people for all that, and with the exception of Zog the magician, they are all supposed to exist in the ocean steps.</p>
</div>
<section id="small100sea_fairies_0812_librivox_64kb_mp301_baum_sea_fairies_64kb_003-chunk-3-of-27" class="level4 cell-output cell-output-display">
<h4 class="anchored" data-anchor-id="small100sea_fairies_0812_librivox_64kb_mp301_baum_sea_fairies_64kb_003-chunk-3-of-27">small/100/sea_fairies_0812_librivox_64kb_mp3/01_baum_sea_fairies_64kb_003 chunk 3 of 27</h4>
</section>
<div class="cell-output cell-output-display">

                <audio controls="controls">
                    <source src="test-3.ogg" type="audio/ogg">
                    Your browser does not support the audio element.
                </audio>
              
</div>
<div class="cell-output cell-output-display">
<p>I am told that some very learned people deny that mermaids or sea serpents have ever inhabited the oceans. But it would be very difficult for them to prove such an assertion, unless they had lived under the water as trot and caten-billed did in this story.</p>
</div>
<section id="small100sea_fairies_0812_librivox_64kb_mp301_baum_sea_fairies_64kb_004-chunk-4-of-27" class="level4 cell-output cell-output-display">
<h4 class="anchored" data-anchor-id="small100sea_fairies_0812_librivox_64kb_mp301_baum_sea_fairies_64kb_004-chunk-4-of-27">small/100/sea_fairies_0812_librivox_64kb_mp3/01_baum_sea_fairies_64kb_004 chunk 4 of 27</h4>
</section>
<div class="cell-output cell-output-display">

                <audio controls="controls">
                    <source src="test-4.ogg" type="audio/ogg">
                    Your browser does not support the audio element.
                </audio>
              
</div>
<div class="cell-output cell-output-display">
<p>I hope my readers who have so long followed Dorothy’s adventures in the Land of Oz will be interested in Trot’s equally strange experiences. The ocean has always appealed to me as a veritable wonderland, and this story has been suggested to me many times by my young correspondence in their letters. Indeed, a good many children have implored me to write something about the mermaids, and I have willingly granted the request.</p>
</div>
<section id="small100sea_fairies_0812_librivox_64kb_mp301_baum_sea_fairies_64kb_005-chunk-5-of-27" class="level4 cell-output cell-output-display">
<h4 class="anchored" data-anchor-id="small100sea_fairies_0812_librivox_64kb_mp301_baum_sea_fairies_64kb_005-chunk-5-of-27">small/100/sea_fairies_0812_librivox_64kb_mp3/01_baum_sea_fairies_64kb_005 chunk 5 of 27</h4>
</section>
<div class="cell-output cell-output-display">

                <audio controls="controls">
                    <source src="test-5.ogg" type="audio/ogg">
                    Your browser does not support the audio element.
                </audio>
              
</div>
<div class="cell-output cell-output-display">
<p>CHAPTER I. TROT AND CAPTAIN BILL. Nobody said Captain Bill solemnly, ever saw a mermaid and lived to tell the tale. Why not, asked TROT, looking earnestly up into the old sailor’s face? They were seated on a bench built around a giant acacia tree that grew just at the edge of the bluff. Below them rolled the blue waves of the great Pacific.</p>
</div>
<section id="small100sea_fairies_0812_librivox_64kb_mp301_baum_sea_fairies_64kb_006-chunk-6-of-27" class="level4 cell-output cell-output-display">
<h4 class="anchored" data-anchor-id="small100sea_fairies_0812_librivox_64kb_mp301_baum_sea_fairies_64kb_006-chunk-6-of-27">small/100/sea_fairies_0812_librivox_64kb_mp3/01_baum_sea_fairies_64kb_006 chunk 6 of 27</h4>
</section>
<div class="cell-output cell-output-display">

                <audio controls="controls">
                    <source src="test-6.ogg" type="audio/ogg">
                    Your browser does not support the audio element.
                </audio>
              
</div>
<div class="cell-output cell-output-display">
<p>A little way behind them was the house, a neat framed cottage painted white and surrounded by huge eucalyptus and pepper trees.</p>
</div>
<section id="small100sea_fairies_0812_librivox_64kb_mp301_baum_sea_fairies_64kb_007-chunk-7-of-27" class="level4 cell-output cell-output-display">
<h4 class="anchored" data-anchor-id="small100sea_fairies_0812_librivox_64kb_mp301_baum_sea_fairies_64kb_007-chunk-7-of-27">small/100/sea_fairies_0812_librivox_64kb_mp3/01_baum_sea_fairies_64kb_007 chunk 7 of 27</h4>
</section>
<div class="cell-output cell-output-display">

                <audio controls="controls">
                    <source src="test-7.ogg" type="audio/ogg">
                    Your browser does not support the audio element.
                </audio>
              
</div>
<div class="cell-output cell-output-display">
<p>Still farther behind that, a quarter of a mile distant but built upon a bend of the coast was the village overlooking a pretty bay. Catonville and Trot came often to this tree to sit and watch the ocean below them. The sailor man had one meat leg and one hickory leg, and he often said the wooden one was the best of the two.</p>
</div>
<section id="small100sea_fairies_0812_librivox_64kb_mp301_baum_sea_fairies_64kb_008-chunk-8-of-27" class="level4 cell-output cell-output-display">
<h4 class="anchored" data-anchor-id="small100sea_fairies_0812_librivox_64kb_mp301_baum_sea_fairies_64kb_008-chunk-8-of-27">small/100/sea_fairies_0812_librivox_64kb_mp3/01_baum_sea_fairies_64kb_008 chunk 8 of 27</h4>
</section>
<div class="cell-output cell-output-display">

                <audio controls="controls">
                    <source src="test-8.ogg" type="audio/ogg">
                    Your browser does not support the audio element.
                </audio>
              
</div>
<div class="cell-output cell-output-display">
<p>Once Catenville had commanded and owned the anemone, a trading schooner that plied along the coast, and in those days Charlie Griffin’s, who was trot’s father, had been the captain’s mate. But ever since Catenville’s accident when he lost his leg, Charlie Griffiths had been the captain of the little schooner, while his old master lived peacefully ashore with the Griffiths family.</p>
</div>
<section id="small100sea_fairies_0812_librivox_64kb_mp301_baum_sea_fairies_64kb_009-chunk-9-of-27" class="level4 cell-output cell-output-display">
<h4 class="anchored" data-anchor-id="small100sea_fairies_0812_librivox_64kb_mp301_baum_sea_fairies_64kb_009-chunk-9-of-27">small/100/sea_fairies_0812_librivox_64kb_mp3/01_baum_sea_fairies_64kb_009 chunk 9 of 27</h4>
</section>
<div class="cell-output cell-output-display">

                <audio controls="controls">
                    <source src="test-9.ogg" type="audio/ogg">
                    Your browser does not support the audio element.
                </audio>
              
</div>
<div class="cell-output cell-output-display">
<p>This was about the time Trot was born, and the old sailor became very fond of the baby girl. Her real name was Mary, but when she grew big enough to walk, she took so many busy little steps every day that both her mother and Captain Bill nicknamed her Trot, and so she was thereafter mostly called.</p>
</div>
</div>
</section>
<section id="batch-processing" class="level2">
<h2 class="anchored" data-anchor-id="batch-processing">Batch processing</h2>
<p>Let’s put everything above together.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>